using System;
using System.Collections.Generic;
using System.Linq;
using System.Text;
using System.Threading.Tasks;

namespace HandGesture
{
    static class StateManager
    {
        delegate void fingersDel();

        enum fstate
        {
            IDLE,
            MOVE,
            LBDOWN,
            LBUP,
            RBDOWN,
            RBUP
        }

        static List<Finger> m_fingers;
        static fingersDel func;
        static int  x, y;
        static double lengthOfIF = 0;

        static public void update(List<Finger> curFingers)
        {
            m_fingers = curFingers;
            if (func != null) func();
            else
            {
                func = idleFunc;
                func();
            }
        }

        static private void idleFunc()
        {
            int i;
            for (i = 0; i < m_fingers.Count && m_fingers[i].m_tipPoint.Count == 0; i++) ;

            if (i == 3)
            {
                Console.WriteLine("change handle");
                ApiController.keybd_event( (uint)System.Windows.Forms.Keys.Up, 0, 0x00, 0);
                func = handleFunc;
                return;
            }
            
            if (i == m_fingers.Count)
            {
                //idle
                return;
            }

            if (m_fingers[i].m_tipPoint.Count == 2)
            {
                Console.WriteLine("changed move mode");
                lengthOfIF = m_fingers[i].m_tipPoint[0].Y > m_fingers[i].m_tipPoint[1].Y ?
                    m_fingers[i].m_tipPoint[0].DistanceTo(m_fingers[i].m_centerPoint)
                    : m_fingers[i].m_tipPoint[1].DistanceTo(m_fingers[i].m_centerPoint);

                x = m_fingers[i].m_centerPoint.X;
                y = m_fingers[i].m_centerPoint.Y;

                func = moveFunc;
            }
        }

        private static void moveFunc()
        {
            int i;
            for (i = 0; i < m_fingers.Count && m_fingers[i].m_tipPoint.Count == 0; i++) ;
            if (i == m_fingers.Count)
            {
                Console.WriteLine("changed idle mode");
                func = idleFunc;
                return;
            }

            if (m_fingers[i].m_tipPoint.Count > 1)
            {
                double tempLengthOfIF = m_fingers[i].m_tipPoint[0].Y < m_fingers[i].m_tipPoint[1].Y ?
                        m_fingers[i].m_tipPoint[0].DistanceTo(m_fingers[i].m_depthPoint[0])
                        : m_fingers[i].m_tipPoint[1].DistanceTo(m_fingers[i].m_depthPoint[1]);

                if (lengthOfIF * 0.6 > tempLengthOfIF)
                {
                    Console.WriteLine("changed rbd");
                    func = rbdFunc;

                    ApiController.mouse_event(ApiController.MOUSEEVENTF_RIGHTDOWN);
                    return;
                }
            }

            if (m_fingers[i].m_tipPoint.Count == 1 || m_fingers[i].GetFingerAngle() < 0.7)
            {
                Console.WriteLine("changed left down mode");
                func = lbdFunc;

                ApiController.mouse_event(ApiController.MOUSEEVENTF_LEFTDOWN);
                return;
            }

            //ApiController.SetCursorPos(m_fingers[i].m_centerPoint.X, m_fingers[i].m_centerPoint.Y);
            ApiController.MoveCursorPos(m_fingers[i].m_centerPoint.X -x, m_fingers[i].m_centerPoint.Y -y);

            return;
        }

        private static void lbdFunc()
        {
            int i;
            for (i = 0; i < m_fingers.Count && m_fingers[i].m_tipPoint.Count == 0; i++) ;
            if (i == m_fingers.Count)
            {
                Console.WriteLine("left up and changed idle mode");
                ApiController.mouse_event(ApiController.MOUSEEVENTF_LEFTUP);
                func = idleFunc;
                return;
            }

            if (m_fingers[i].m_tipPoint.Count > 1 && m_fingers[i].GetFingerAngle() > 0.7)
            {
                ApiController.mouse_event(ApiController.MOUSEEVENTF_LEFTUP);
                Console.WriteLine("left up and changed move mode");
                func = idleFunc;
                return;
            }
        }

        static void rbdFunc()
        {
            int i;
            for (i = 0; i < m_fingers.Count && m_fingers[i].m_tipPoint.Count == 0; i++) ;

            if (i == m_fingers.Count)
            {
                Console.WriteLine("right up and changed idle mode");
                ApiController.mouse_event(ApiController.MOUSEEVENTF_LEFTUP);
                func = idleFunc;
                return;
            }

            if (m_fingers[i].m_tipPoint.Count > 1)
            {
                double tempLengthOfIF = m_fingers[i].m_tipPoint[0].Y < m_fingers[i].m_tipPoint[1].Y ?
                        m_fingers[i].m_tipPoint[0].DistanceTo(m_fingers[i].m_depthPoint[0])
                        : m_fingers[i].m_tipPoint[1].DistanceTo(m_fingers[i].m_depthPoint[1]);

                if (lengthOfIF * 0.8 < tempLengthOfIF)
                {
                    Console.WriteLine("changed rbd to move");
                    func += moveFunc;

                    ApiController.mouse_event(ApiController.MOUSEEVENTF_RIGHTUP);
                    return;
                }
            }

        }
        static public void handleFunc(){
            int i;
            int ri = 0, li = 0;

            for (i = 0; i < m_fingers.Count && m_fingers[i].m_tipPoint.Count == 0; i++)
            {
                int temp = m_fingers[i].m_centerPoint.X;
                if (m_fingers[ri].m_centerPoint.X < temp)
                {
                    ri = i;
                }

                if (m_fingers[li].m_centerPoint.X > temp)
                {
                    li = i;
                }
            }

            if (m_fingers.Count < 3)
            {
                Console.WriteLine("change idle state");
                ApiController.keybd_event((uint)System.Windows.Forms.Keys.Up, 0, 0x02, 0);
                //ApiController.keybd_event((uint)System.Windows.Forms.Keys.Right, 0, 0x02, 0);
                //ApiController.keybd_event((uint)System.Windows.Forms.Keys.Left, 0, 0x02, 0);
                func = idleFunc;
                return;
            }

            if (Math.Abs(m_fingers[li].m_centerPoint.Y - m_fingers[ri].m_centerPoint.Y) > m_fingers[li].m_rad)
            {
                if (m_fingers[li].m_centerPoint.Y < m_fingers[ri].m_centerPoint.Y)
                {
                    ApiController.keybd_event((uint)System.Windows.Forms.Keys.Left, 0, 0x00, 0);
                    System.Threading.Thread.Sleep(100);
                    ApiController.keybd_event((uint)System.Windows.Forms.Keys.Left, 0, 0x02, 0);
                }
                else
                {
                    ApiController.keybd_event((uint)System.Windows.Forms.Keys.Right, 0, 0x00, 0);
                    System.Threading.Thread.Sleep(100);
                    ApiController.keybd_event((uint)System.Windows.Forms.Keys.Right, 0, 0x02, 0);
                }
            }
            return;
        }
    }
}
